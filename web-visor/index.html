<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visor de Lotes - Quinind√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #panel {
      position: absolute;
      top: 12px; left: 12px;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.18);
      z-index: 1000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-width: 260px;
      max-width: 340px;
    }
    #title { font-weight: 700; margin-bottom: 6px; }
    #status { font-size: 13px; color: #333; margin-bottom: 8px; }
    #legendWrap { margin-top: 10px; }
    #legendWrap img { width: 100%; border: 1px solid #eee; border-radius: 10px; }
    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f2f2f2;
      font-size: 12px;
      margin-top: 6px;
    }
    .hint { font-size: 12px; color: #555; line-height: 1.3; margin-top: 8px; }
    .muted { color: #666; }
  </style>
</head>

<body>
  <div id="panel">
    <div id="title">Visor de Lotes</div>
    <div id="status">Cargando‚Ä¶</div>
    <div class="pill" id="qrPill">QR: <span class="muted">‚Äî</span></div>

    <div class="hint">
      ‚Ä¢ Click en un lote para ver info<br/>
      ‚Ä¢ O usa <b>?id_lote=123</b> en el link (QR)
    </div>

    <div id="legendWrap">
      <div style="font-weight:600; margin:10px 0 6px;">Leyenda</div>
      <img id="legendImg" alt="Leyenda WMS" />
    </div>
  </div>

  <div id="map"></div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const OWS_BASE = "https://demoquininde-production.up.railway.app/ows/";
    const LAYER_NAME = "lotes_demo";      // <- tu capa publicada
    const ID_FIELD   = "OBJECTID";        // <- cambia si tu campo es otro (ej. "id_lote")

    // Zoom inicial (si NO viene id_lote)
    const DEFAULT_VIEW = { lat: 0.0, lng: -79.45, z: 12 };

    // =========================
    // Helpers
    // =========================
    const qs = new URLSearchParams(window.location.search);
    const idLote = qs.get("id_lote");

    const statusEl = document.getElementById("status");
    const qrPill   = document.getElementById("qrPill");

    qrPill.innerHTML = `QR: <span class="muted">${idLote ?? "‚Äî"}</span>`;

    function setStatus(msg) { statusEl.textContent = msg; }

    function toLatLngBoundsFromGeoJSON(geojson) {
      const layer = L.geoJSON(geojson);
      return layer.getBounds();
    }

    // =========================
    // Map
    // =========================
    const map = L.map("map").setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.z);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20,
      attribution: "¬© OpenStreetMap"
    }).addTo(map);

    // WMS overlay
    const wmsLayer = L.tileLayer.wms(OWS_BASE, {
      layers: LAYER_NAME,
      format: "image/png",
      transparent: true,
      version: "1.3.0"
    }).addTo(map);

    // Leyenda real desde el WMS
    const legendUrl =
      `${OWS_BASE}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetLegendGraphic` +
      `&FORMAT=image/png&LAYER=${encodeURIComponent(LAYER_NAME)}`;

    document.getElementById("legendImg").src = legendUrl;

    // Pane para highlight
    map.createPane("highlight");
    map.getPane("highlight").style.zIndex = 650;

    let highlightLayer = null;
    function clearHighlight() {
      if (highlightLayer) {
        map.removeLayer(highlightLayer);
        highlightLayer = null;
      }
    }

    // =========================
    // 1) Si viene id_lote (por QR): buscar por WFS y resaltar + zoom
    // =========================
    async function zoomToLoteByWFS(idValue) {
      // WFS GeoJSON
      const baseWFS =
        `${OWS_BASE}?SERVICE=WFS&VERSION=1.1.0&REQUEST=GetFeature` +
        `&TYPENAME=${encodeURIComponent(LAYER_NAME)}` +
        `&OUTPUTFORMAT=application/json`;

      // Filter XML igual que tu versi√≥n local
      const filterXml = `
        <Filter>
          <PropertyIsEqualTo>
            <PropertyName>${ID_FIELD}</PropertyName>
            <Literal>${idValue}</Literal>
          </PropertyIsEqualTo>
        </Filter>`;

      const url = baseWFS + "&FILTER=" + encodeURIComponent(filterXml);

      setStatus(`Buscando lote ${idValue}‚Ä¶`);

      const r = await fetch(url);
      if (!r.ok) throw new Error("WFS no respondi√≥ OK");
      const data = await r.json();

      if (!data.features || data.features.length === 0) {
        setStatus(`‚ùå No se encontr√≥ el lote ${idValue}`);
        return;
      }

      clearHighlight();

      const feature = data.features[0];
      highlightLayer = L.geoJSON(feature, {
        pane: "highlight",
        style: { color: "red", weight: 3, fillOpacity: 0.35 }
      }).addTo(map);

      map.fitBounds(highlightLayer.getBounds(), { maxZoom: 19 });

      const props = feature.properties || {};
      const popup = `
        <b>Lote:</b> ${props[ID_FIELD] ?? "‚Äî"}<br>
        <b>Estado:</b> ${props.estado ?? props.ESTADO ?? "‚Äî"}<br>
        <b>Clave catastral:</b> ${props.CLAVE_CATA ?? props.clave_catastral ?? "‚Äî"}<br>
        <b>Parroquia:</b> ${props.PARROQUIA ?? props.parroquia ?? "‚Äî"}
      `;

      highlightLayer.bindPopup(popup).openPopup();
      setStatus(`‚úÖ Lote ${props[ID_FIELD] ?? idValue} encontrado`);
    }

    // =========================
    // 2) Click: GetFeatureInfo (para verificar info sin depender del WFS)
    // =========================
    function getFeatureInfoUrl(latlng) {
      const point = map.latLngToContainerPoint(latlng, map.getZoom());
      const size  = map.getSize();

      // BBOX en EPSG:3857 para que sea consistente con OSM
      // Leaflet por defecto trabaja en 3857 para tiles.
      const bounds = map.getBounds();
      const sw = bounds.getSouthWest();
      const ne = bounds.getNorthEast();

      // Convert latlng to EPSG:3857 bbox
      function project3857(ll) {
        const d = Math.PI / 180;
        const max = 85.0511287798;
        const lat = Math.max(Math.min(max, ll.lat), -max);
        const sin = Math.sin(lat * d);
        const x = 6378137 * ll.lng * d;
        const y = 6378137 * Math.log((1 + sin) / (1 - sin)) / 2;
        return { x, y };
      }

      const swm = project3857(sw);
      const nem = project3857(ne);
      const bbox = `${swm.x},${swm.y},${nem.x},${nem.y}`;

      // WMS 1.3.0 usa i/j y CRS
      const params =
        `SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo` +
        `&LAYERS=${encodeURIComponent(LAYER_NAME)}` +
        `&QUERY_LAYERS=${encodeURIComponent(LAYER_NAME)}` +
        `&CRS=EPSG:3857` +
        `&BBOX=${bbox}` +
        `&WIDTH=${size.x}&HEIGHT=${size.y}` +
        `&I=${Math.round(point.x)}&J=${Math.round(point.y)}` +
        `&INFO_FORMAT=application/json` +
        `&FEATURE_COUNT=5`;

      return `${OWS_BASE}?${params}`;
    }

    async function onMapClick(e) {
      try {
        const url = getFeatureInfoUrl(e.latlng);
        const r = await fetch(url);
        if (!r.ok) throw new Error("GetFeatureInfo no respondi√≥ OK");

        const data = await r.json();

        const features = data.features || [];
        if (!features.length) {
          setStatus("üëÄ No hay lote en ese punto (o est√° fuera).");
          return;
        }

        // Tomamos la primera coincidencia
        const f = features[0];
        const props = f.properties || {};

        setStatus("‚úÖ Info cargada (click).");

        // Si viene geometr√≠a, resalta. Si no, solo popup.
        clearHighlight();
        if (f.geometry) {
          highlightLayer = L.geoJSON(f, {
            pane: "highlight",
            style: { color: "#111", weight: 3, fillOpacity: 0.2 }
          }).addTo(map);
        }

  

        const popup = `
          <b>Lote (ID):</b> ${props[ID_FIELD] ?? "‚Äî"}<br>
          <b>Permiso:</b> <b>${props.PERMISO ?? "‚Äî"}</b><br>
          <b>Clave catastral:</b> ${props.CLAVE_CATA ?? "‚Äî"}<br>
          <b>√Årea (m¬≤):</b> ${props.AREA_TERRE ?? "‚Äî"}<br>
          <b>Parroquia:</b> ${props.PARROQUIA ?? "‚Äî"}
        `;


        L.popup()
          .setLatLng(e.latlng)
          .setContent(popup)
          .openOn(map);

      } catch (err) {
        console.error(err);
        setStatus("‚ö†Ô∏è Error consultando GetFeatureInfo.");
      }
    }

    map.on("click", onMapClick);

    // =========================
    // Init
    // =========================
    (async function init() {
      try {
        // Si viene QR, zoom por WFS
        if (idLote) {
          await zoomToLoteByWFS(idLote);
        } else {
          setStatus("Mapa listo. Tip: agrega ?id_lote=123 (QR).");
        }
      } catch (e) {
        console.error(e);
        setStatus("‚ö†Ô∏è No se pudo hacer zoom por WFS. Igual puedes verificar con click.");
      }
    })();
  </script>
</body>
</html>
